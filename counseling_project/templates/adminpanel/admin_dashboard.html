{% extends 'layout.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block title %}Admin Dashboard{% endblock %}

    {% block navbar %}
    <nav class="navbar">
           <div class="branding-text">
      <h1>üéìXYZ College of Engineering, City</h1>
      <p>Online Student Counseling & Admission Portal</p>
    </div>
     <div><a style="border:none; text-decoration: none;font-size:1.3rem; color:black;"href="{% url 'admin_dashboard' %}">üéìAdmin Dashboard</a></div>
       <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
     <ul class="navlinks" id="navLinks">

            <li><a href="{% url 'admin_logout' %}" class="btn btn-outline-light">Admin Logout</a></li>
      
        </ul>
    </nav>
    {% endblock %}

{% block content %}
<h2 style="text-align: center;color:white;">Welcome {{ user.username }}</h2>
<div class="dashboard-cards-container">

    <!-- 1. View Student Table -->
    <div class="dashboard-card">
        <h3 class="text-lg font-bold mb-2">üìã View Students</h5>
        <p  class="text-gray-600 mb-3">Open student list and verification table.</p>
        <button class="btn btn-primary" onclick="openStudentModal()">Open Table</button>
    </div>

    <!-- 2. Admin Help -->
    <div class="dashboard-card">
        <h3 class="text-lg font-bold mb-2">üõ†Ô∏è Admin Help</h5>
        <p  class="text-gray-600 mb-3">Need a guide for admin tasks?</p>
        <button class="btn btn-info" onclick="openAdminHelpModal()">Open Help</button>
    </div>

    <!-- 3. Run Allocation -->
    <div class="dashboard-card">
        <h3 class="text-lg font-bold mb-2">üéØ Run Seat Allocation</h5>
        <p  class="text-gray-600 mb-3">Automatically rank students and assign branches.</p>
        <form method="post" action="{% url 'run_allocation' %}">
            {% csrf_token %}
           <button class="btn btn-danger" onclick="return confirm('Are you sure you want to run seat allocation? This cannot be undone!')">Run Allocation</button>
        </form>
    </div>

    <!-- 4. Send Notifications -->
    <div class="dashboard-card">
        <h3 class="text-lg font-bold mb-2">üì¢ Send Notifications</h5>
        <p  class="text-gray-600 mb-3">Notify students about seat allotments.</p>
        <form method="post" action="{% url 'send_notifications' %}">
            {% csrf_token %}
           <button class="btn btn-warning" onclick="return confirm('Are you sure you want to send notifications to all students?')">Send Notifications</button>
        </form>
    </div>

</div>

<!-- üì¶ STUDENT MODAL TABLE -->
<div id="studentModal" class="modal-container" style="display:none; ">
    <div class="modal-content">
        <span class="closebtn" onclick="closeStudentModal()">&times;</span>

        <h2 class="my-4">üìã Student Verification Panel</h2>

        <p >Total Students: {{ students|length }}</p>

        <h4>üéì Branch Seat Info</h4>
        <table class="styled-table">
            <thead>
                <tr>
                    <th>Branch</th>
                    <th>Total Seats</th>
                    <th>Filled Seats</th>
                </tr>
            </thead>
            <tbody>
                {% for branch in branches %}
                <tr>
                    <td>{{ branch.name }}</td>
                    <td>{{ branch.total_seats }}</td>
                    <td>{{ branch.filled_seats }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h4 class="mt-4">üìÑ Student Table</h4>
        <table class="styled-table mt-2">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Rank</th>
                    <th>Branch allocated</th>
                    <th>Receipt</th>
                    <th>Approval</th>
                    <th>View</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ student.name }}</td>
                    <td>{{ student.status }}</td>
                    <td>{{ student.rank|default_if_none:"Not Allotted" }}</td>
                    <td>{{ student.allocated_branch|default:"Not Allotted" }}</td>
                    <td>
                        {% if student.receipt %}
                        <a href="{{ student.receipt }}" target="_blank" class="btn btn-sm btn-info">View</a>
                        {% else %}
                        <span class="text-danger">Not Uploaded</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if student.receipt and not student.receipt_verified %}
                        <form method="POST" action="{% url 'approve_receipt' student.id %}">
                            {% csrf_token %}
                            <button class="btn btn-success btn-sm">Approve</button>
                        </form>
                        {% elif student.receipt_verified %}
                        ‚úÖ Approved
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'view_student' student.id %}" class="btn btn-primary btn-sm">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- üß† ADMIN HELP MODAL -->
<div id="adminHelpModal" class="modal-container" style="display:none;">
    <div class="modal-content">
        <span class="closebtn" onclick="closeAdminHelpModal()">&times;</span>
        <h3>üë®‚Äçüíº Admin Dashboard Guide</h3>
        <ol style="line-height: 1.8;">

            <li>
                <strong> Verify Student Applications:</strong><br>
                Check submitted student profiles and academic details.
                <ul>
                    <li>Click ‚ÄúApprove‚Äù if details are correct.</li>
                    <li>Click ‚ÄúReject‚Äù to discard invalid data.</li>
                </ul>
            </li>

            <li class="mt-3">
                <strong> Run Seat Allocation:</strong><br>
                After all students are verified, click <em>"Run Allocation"</em>.<br>
                This will:
                <ul>
                    <li>Calculate rank based on: <br>
                        <small>‚Üí 70% of 12th PCM marks + 30% of 10th marks</small>
                    </li>
                    <li>Allot branches to <strong>all students at once</strong> based on:
                        <ul>
                            <li>Rank</li>
                            <li>Branch preferences (1st and 2nd)</li>
                            <li>Seat availability</li>
                        </ul>
                    </li>
                </ul>
            </li>

            <li class="mt-3">
                <strong> Send Notifications:</strong><br>
                Use the <em>"Send Notifications"</em> button to inform students about:
                <ul>
                    <li>Whether they‚Äôve been allocated a seat or not.</li>
                    <li>Instructions to proceed to fee submission.</li>
                </ul>
            </li>

            <li class="mt-3">
                <strong> Approve Fee Receipts:</strong><br>
                Students upload a screenshot/photo of the payment receipt.
                <ul>
                    <li>Approve it if the payment is correct.</li>
                    <li>This confirms the student‚Äôs seat.</li>
                </ul>
            </li>

            <li class="mt-3">
                <strong> Final Confirmation & Offer Letter:</strong><br>
                Once fee is approved:
                <ul>
                    <li>The student receives a notification of confirmation.</li>
                    <li>The <strong>‚ÄúDownload Offer Letter‚Äù</strong> option becomes available to the student.</li>
                </ul>
            </li>
        </ol>

    </div>
</div>
{% endblock %}

{% block footer %}
{% endblock%}

{% block scripts %}
<script src="{% static 'js/dashboard.js' %}"></script>
<script>
    function openAdminHelpModal() {
        document.getElementById("adminHelpModal").style.display = "block";
    }

    function closeAdminHelpModal() {
        document.getElementById("adminHelpModal").style.display = "none";
    }

    function openStudentModal() {
        document.getElementById("studentModal").style.display = "block";
    }

    function closeStudentModal() {
        document.getElementById("studentModal").style.display = "none";
    }

    // Close modals when clicking outside
    window.onclick = function (event) {
        if (event.target === document.getElementById("adminHelpModal")) {
            closeAdminHelpModal();
        }
        if (event.target === document.getElementById("studentModal")) {
            closeStudentModal();
        }
    };
</script>
        <script src="{% static 'js/hamburger.js' %}"></script>
{% endblock %}
