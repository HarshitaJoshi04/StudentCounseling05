{% extends 'layout.html' %} {% load static %} {% load widget_tweaks %} {% block
extra_css %}

<link rel="stylesheet" href="{% static 'css/student_dashboard.css' %}" />
{% endblock %} {% block title %}Student Dashboard{% endblock %} {% block navbar
%}
<nav class="navbar">
  <div class="profile-dropdown">
    {% if profile %}
    <img
      src="{{ profile.profile_picture.url }}"
      alt="Avatar"
      class="navbar-avatar"
    />
    {% else %}
    <img
      src="{% static 'images/default-avatar.png' %}"
      alt="Default Avatar"
      class="navbar-avatar"
    />
    {% endif %}
  </div>
  <div class="branding-text">
    <h1>üéìXYZ College of Engineering, City</h1>
    <p>Online Student Counseling & Admission Portal</p>
  </div>

  <div class="notification">
    <!-- üìç Notification Bell -->
    <a
      href="{% url 'student_notifications' %}"
      class="notification-icon border-0 text-decoration-none"
    >
      üîî {% if unread_count > 0 %}
      <span class="notification-badge">{{ unread_count }}</span>
      {% endif %}
    </a>
  </div>
  {% comment %} hamburger {% endcomment %}
  <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
  <ul class="navlinks" id="navLinks">
    <li>
      <a href="{% url 'student_dashboard' %}" class="btn btn-outline-light"
        >Home</a
      >
    </li>
    <li>
      <a href="{% url 'student_logout' %}" class="btn btn-outline-light"
        >Student Logout</a
      >
    </li>
  </ul>
</nav>
{% endblock %} {% block content %}
<h2 style="text-align: center; color: white">Welcome {{ user.username }}</h2>
<div id="dropdown-menu" class="dropdown-content">
  <a href="javascript:void(0);" onclick="openInfoModal()">üë§ Personal Info</a>

  <a href="{% url 'student_logout' %}">üö™ Logout</a>
</div>

<div class="page-transition">
  {% comment %} personal info {% endcomment %}
  <div id="infoModal" class="modal">
    <div class="modal-Content">
      <span class="close-btn" onclick="closeInfoModal()">&times;</span>

      <div class="personal-info-card">
        {% if profile %}
        <img
          src="{{ profile.profile_picture.url }}"
          alt="Avatar"
          class="navbar-avatar"
        />
        {% else %}
        <img
          src="{% static 'images/default-avatar.png' %}"
          alt="Default Avatar"
          class="navbar-avatar"
        />
        {% endif %}

        <div class="info-details">
          <h2>{{ user.get_full_name }}</h2>
          <p><strong>Username:</strong> {{ user.username }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p>
            <strong>Phone:</strong> {{ profile.phone|default:"Not Provided" }}
          </p>
        </div>
      </div>
    </div>
  </div>

  {% if registration_open %}
  <div style="text-align: center">
    <button id="toggleFormBtn" class="btn btn-primary mt-3">Fill Form</button>
  </div>

  <!-- Modal Container -->
  <div id="formModal" class="modal-container">
    <div class="modal-content">
      <!--closebutton-->
      <span class="closebtn">&times;</span>

      <!-- Hidden Form -->
      <div id="formSection" class="formsection">
        {% if already_filled|default:False %}
        <div
          class="submitted-message"
          style="text-align: center; padding: 20px"
        >
          <h2 style="color: green">‚úÖ You have already submitted the form!</h2>
          <p>If you want to update your details, please contact admin.</p>
        </div>
        {% else %}

        <h2 class="heading">Fill this form</h2>
        <form
          method="POST"
          enctype="multipart/form-data"
          class="student-form"
          style="max-width: 700px; margin: auto"
        >
          {% csrf_token %}
          <h4>üìù Personal Information</h4>

          {% for field in profile_form %}
          <div class="form-group mb-3">
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field|add_class:"form-control custom-input " }} {% if
            field.errors %}
            <div class="text-danger mt-1">{{ field.errors }}</div>
            {% endif %}
          </div>
          {% endfor %}

          <h4>üìä Marks Information</h4>
          {% for field in marks_form %}
          <div class="form-group mb-3">
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field|add_class:"form-control custom-input" }} {% if field.errors
            %}
            <div class="text-danger mt-1">{{ field.errors }}</div>
            {% endif %}
          </div>
          {% endfor %}

          <button type="submit" class="btn btn-primary mt-3 w-100">
            Submit
          </button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>
  {% else %}
  <!-- Registration is closed -->
  <button disabled style="background: white; color: black; padding: 12px">
    Registration Closed
  </button>
  {% endif %}

  <!-- üöÄ Dashboard Cards Section -->
  <div class="dashboard-cards">
    <!-- Card 1: Fill Form -->
    <div class="dashboard-card">
      <h3 class="text-lg font-bold mb-2">üìù Fill Form</h3>
      <p class="text-gray-600 mb-3">
        Submit your profile and academic details.
      </p>

      {% if registration_open %} {% if already_filled %}
      <button
        class="bg-gray-300 text-gray-700 px-3 py-2 rounded-md cursor-not-allowed"
        disabled
      >
        Already Submitted
      </button>
      {% else %}
      <button
        onclick="openFormModal()"
        class="bg-indigo-600 text-white px-3 py-2 rounded-md hover:bg-indigo-700 transition"
      >
        Open
      </button>
      {% endif %} {% else %}
      <button
        class="bg-gray-300 text-gray-700 px-3 py-2 rounded-md cursor-not-allowed"
        disabled
      >
        Registration Closed
      </button>
      {% endif %}
    </div>

    <!-- Pay & Upload Card -->
    <div class="dashboard-card">
      <h3 class="text-lg font-bold mb-2">üí≥ Pay &<br />Upload</h3>
      <p class="text-gray-600 mb-3">
        Upload your payment receipt<br />after seat allotment.
      </p>

      {% if profile.seat_allocated %} {% if not profile.feereceipt %}
      <button class="btn btn-primary mt-2" onclick="openFeeModal()">
        Open
      </button>
      {% else %}
      <p style="color: green">‚úÖ Uploaded</p>
      {% endif %} {% else %}
      <button disabled class="btn btn-secondary mt-2">Seat Not Allotted</button>
      {% endif %}
    </div>

    <div class="dashboard-card">
      <h3 class="text-lg font-bold mb-2">Offer Letter</h3>
      <p class="text-gray-600 mb-3">kindly Download it.</p>
      {% if profile.seat_allocated and allocation.is_verified %}
      <a href="{% url 'download_offer_letter' %}" class="btn btn-success mt-3">
        üì• Download Offer Letter
      </a>
      {% endif %}
    </div>

    <div class="dashboard-card">
      <h5 class="text-lg font-bold mb-2">‚ùì Need Help?</h5>
      <p class="text-gray-600 mb-3">Confused about the process?</p>
      <button class="btn btn-primary" onclick="openHelpModal()">
        Open Help
      </button>
    </div>
  </div>
  {% comment %} help modal {% endcomment %}
  <div id="helpModal" class="modal-container" style="display: none">
    <div class="modal-content">
      <span class="closebtn" onclick="closeHelpModal()">&times;</span>
      <h3>üìù Counseling Process Guide</h3>
      <ol style="line-height: 1.8">
        <li>
          <strong> Fill Your Profile:</strong><br />
          Submit your personal details and academic marks for 10th and 12th
          (PCM).
        </li>

        <li class="mt-3">
          <strong> Choose Branch Preferences:</strong><br />
          Select your top two preferred branches for seat allocation.
        </li>

        <li class="mt-3">
          <strong> Wait for Admin Verification:</strong><br />
          Once you submit your form, wait for the admin to verify your details.
          <ul>
            <li>You‚Äôll get a notification if approved.</li>
            <li>If rejected, re-fill your form correctly.</li>
          </ul>
        </li>

        <li class="mt-3">
          <strong> Seat Allocation:</strong><br />
          Admin will run seat allocation based on:
          <ul>
            <li>Your 10th & 12th marks (rank is calculated automatically)</li>
            <li>Your branch preferences</li>
            <li>Seat availability</li>
          </ul>
        </li>

        <li class="mt-3">
          <strong> View Allocation Result:</strong><br />
          After allocation, you'll get a notification showing:
          <ul>
            <li>Your allotted branch (if any)</li>
            <li>Your rank</li>
            <li>Instructions to proceed with payment</li>
          </ul>
        </li>

        <li class="mt-3">
          <strong> Upload Fee Receipt:</strong><br />
          Pay the counseling fee in the bank and upload the receipt in the
          portal.
        </li>

        <li class="mt-3">
          <strong> Final Confirmation & Offer Letter:</strong><br />
          Once your receipt is approved:
          <ul>
            <li>Your seat will be confirmed</li>
            <li>You can download your official offer letter</li>
          </ul>
        </li>
      </ol>

      <hr />
      <p class="text-muted small">
        ‚ÑπÔ∏è <strong>Note:</strong> Make sure to check your notifications
        regularly. Once your seat is confirmed, you can‚Äôt edit your data.
      </p>
    </div>
  </div>

  <!-- Fee Receipt Modal -->
  <div id="feeModal" class="modal-container">
    <div class="modal-content">
      <span class="closebtn-fee" onclick="closeFeeModal()">&times;</span>
      <h2>Upload Payment Receipt</h2>
      <form
        method="POST"
        enctype="multipart/form-data"
        action="{% url 'upload_fee_receipt' %}"
      >
        {% csrf_token %}
        <input type="file" name="receipt" class="form-control" required />
        <button type="submit" class="btn btn-success mt-3">Upload</button>
      </form>
    </div>

    {% endblock %} {% block footer %} {% endblock%} {% block scripts %}

    <script src="{% static 'js/hamburger.js' %}"></script>
    <script src="{% static 'js/dashboard.js' %}"></script>
    {% endblock %}
  </div>
</div>
